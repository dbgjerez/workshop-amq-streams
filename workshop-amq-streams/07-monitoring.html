<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Monitoring :: Workshop AMQ Streams</title>
    <link rel="canonical" href="https://github.com/dbgjerez/workshop-amq-streams/workshop-amq-streams/07-monitoring.html">
    <link rel="prev" href="06-data.html">
    <link rel="next" href="08-security.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://github.com/dbgjerez/workshop-amq-streams">Workshop AMQ Streams</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-amq-streams" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">AMQ Streams</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-introduction.html">1. Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-introduction.html#architecture">Architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-operator.html">2. Operator</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-operator.html#installation">Installation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-cluster.html">3. Kafka Cluster</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-topic.html">4. Kafka Topic</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-user.html">5. Kafka User</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-data.html">6. Data streaming</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-data.html#producersandconsumers">Producers and consumers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-data.html#simple">Simple data</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-data.html#sendsimpledata">Send plain text</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-data.html#receivesimpledata">Receive plain text</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-data.html#json">JSON</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-data.html#sendjson">Send JSON</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-data.html#receivejson">Receive JSON</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-data.html#avro">Avro scheme</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="07-monitoring.html">7. Monitoring</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-security.html">8. Security</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">AMQ Streams</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">AMQ Streams</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">AMQ Streams</a></li>
    <li><a href="07-monitoring.html">7. Monitoring</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/dbgjerez/workshop-amq-streams/edit/master/doc-gh-pages/documentation/modules/ROOT/pages/07-monitoring.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Monitoring</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Monitoring is a important topic overall when it refers to distributed or complex systems. In order to monitor AMQ Broker, it supports Prometheus metrics using Prometheus JMX exporter to convert the JMX metrics supported by Apacha Kafka and Apache Zookeeper to Prometheus metrics. This feature will help us to monitorize the cluster using Prometheus to extract and store metrics and Grafana to expose them into dashboards.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operators_installation"><a class="anchor" href="#_operators_installation"></a>Operators Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As any Operator installation in Openshift you can installed eighter by web console or cli console, you can do it as you want, however during the lab we will use cli console.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
To deploy Prometheus and Grafana Operators we need to install previously an OperatorGroup to match the Operator&#8217;s installation mode and the namespace. This step is describe in <a href="https://docs.openshift.com/container-platform/4.12/operators/admin/olm-adding-operators-to-cluster.html">Adding Operators to a cluster</a> page from <a href="https://docs.openshift.com/container-platform/4.12/welcome/index.html">OpenShift Documentation site</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First we need deploy an OperatorGroup in the namespace where we&#8217;ll deploy or install Grafana and Prometheus operators. So we can use the following descriptor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: monitoring-operatorgroup
  namespace: kafka
spec:
  targetNamespaces:
  - kafka</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take a look and then, just apply it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc apply -f operator/operator-group-monitoring.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the OperatorGroup has been deployed, then you can deploy Grafana and Prometheus operator subscriptions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc apply -f operator/grafana-operator.yaml -n $OCP_NS
oc apply -f operator/prometheus-operator.yaml -n $OCP_NS</code></pre>
</div>
</div>
<div class="paragraph">
<p>To ensure that all operators have been installed properly you can check it with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc get csv -n $OCP_NS</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_a_kafka_cluster"><a class="anchor" href="#_deploy_a_kafka_cluster"></a>Deploy a Kafka cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first step to monitoring a cluster is export metrics in order to Prometheus can extract them and stored. To achieve this the cluster must be deployed with some specific configuration parameters. In that case, the configuration required are located into ConfigMaps resources and they will be binded to the cluster configuration.</p>
</div>
<div class="paragraph">
<p>So, before go on we need remove the current Kafka cluster. Once the cluster have been deleted we will create a new one with the required monitoring configuration.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the required configuration. Firstly we need to create the ConfigMap resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc apply -n $OCP_NS -f components/monitoring/kafka/kafka-metrics-cm.yaml
oc apply -n $OCP_NS -f components/monitoring/kafka/kafka-cruise-control-cm.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once configuration resources has been created, then we are going to deploy a new Kafka cluster with metrics exportation configuration, for this purpose we need to add the following code in Zookeeper and Cruise Control section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">metricsConfig:
    type: jmxPrometheusExporter
    valueFrom:
    configMapKeyRef:
        name: &lt;secret&gt;
        key: &lt;file&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take a look to the full descriptor and then apply in the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: kafka
  labels:
    app: kafka
spec:
  entityOperator:
    topicOperator: {}
    userOperator: {}
  kafka:
    version: 3.3.1
    replicas: 3
    config:
      offsets.topic.replication.factor: 1
      transaction.state.log.replication.factor: 1
      transaction.state.log.min.isr: 1
      default.replication.factor: 1
      min.insync.replicas: 1
      inter.broker.protocol.version: "3.3"
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
      - name: tls
        port: 9093
        type: internal
        tls: true
      - name: routetls
        port: 9094
        type: route
        tls: true
        authentication:
          type: tls
    metricsConfig:
      type: jmxPrometheusExporter
      valueFrom:
        configMapKeyRef:
          name: kafka-metrics
          key: kafka-metrics-config.yml 
    authorization:
      type: simple
    storage:
      type: ephemeral
  zookeeper:
    replicas: 3
    metricsConfig:
      type: jmxPrometheusExporter
      valueFrom:
        configMapKeyRef:
          name: kafka-metrics
          key: zookeeper-metrics-config.yml
    storage:
      type: ephemeral
  kafkaExporter:
    topicRegex: ".*"
    groupRegex: ".*"
    readinessProbe:
      initialDelaySeconds: 15
      timeoutSeconds: 5
    livenessProbe:
      initialDelaySeconds: 15
      timeoutSeconds: 5
  cruiseControl:
    metricsConfig:
      type: jmxPrometheusExporter
      valueFrom:
        configMapKeyRef:
          name: cruise-control-metrics
          key: metrics-config.yml</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_prometheus"><a class="anchor" href="#_deploy_prometheus"></a>Deploy Prometheus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will use Prometheus to extract and gather all metric data. In order to use it, we need to create a new Prometheus instance, for that it has been provided all descriptor needed to create the required resources, so you only need apply them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc apply -n $OCP_NS -f components/monitoring/prometheus</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look to prometheus-pod-monitor.yaml descriptor, which define a PodMonitor resource that specifies to Prometheus where metrics will be exposed</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: cluster-operator-metrics
  labels:
    app: strimzi
spec:
  selector:
    matchLabels:
      strimzi.io/kind: cluster-operator
  namespaceSelector:
    matchNames:
      - kafka
  podMetricsEndpoints:
  - path: /metrics
    port: http
---
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: entity-operator-metrics
  labels:
    app: strimzi
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: entity-operator
  namespaceSelector:
    matchNames:
      - kafka
  podMetricsEndpoints:
  - path: /metrics
    port: healthcheck
---
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: bridge-metrics
  labels:
    app: strimzi
spec:
  selector:
    matchLabels:
      strimzi.io/kind: KafkaBridge
  namespaceSelector:
    matchNames:
      - kafka
  podMetricsEndpoints:
  - path: /metrics
    port: rest-api
---
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: kafka-resources-metrics
  labels:
    app: strimzi
spec:
  selector:
    matchExpressions:
      - key: "strimzi.io/kind"
        operator: In
        values: ["Kafka", "KafkaConnect", "KafkaConnectS2I", "KafkaMirrorMaker", "KafkaMirrorMaker2"]
  namespaceSelector:
    matchNames:
      - kafka
  podMetricsEndpoints:
  - path: /metrics
    port: tcp-prometheus
    relabelings:
    - separator: ;
      regex: __meta_kubernetes_pod_label_(strimzi_io_.+)
      replacement: $1
      action: labelmap
    - sourceLabels: [__meta_kubernetes_namespace]
      separator: ;
      regex: (.*)
      targetLabel: namespace
      replacement: $1
      action: replace
    - sourceLabels: [__meta_kubernetes_pod_name]
      separator: ;
      regex: (.*)
      targetLabel: kubernetes_pod_name
      replacement: $1
      action: replace
    - sourceLabels: [__meta_kubernetes_pod_node_name]
      separator: ;
      regex: (.*)
      targetLabel: node_name
      replacement: $1
      action: replace
    - sourceLabels: [__meta_kubernetes_pod_host_ip]
      separator: ;
      regex: (.*)
      targetLabel: node_ip
      replacement: $1
      action: replace</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take special attention to podMetricsEndpoint and namespaceSelector sections, it defines here the path where metrics  and the namespace where will be exposed.</p>
</div>
<div class="paragraph">
<p>After a few minutes, you can access to the Prometheus instance and check if it has receive some metrics data. To access just get route endpoint and open it up in you browser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc get route -n $OCP_NS prometheus -o template --template='{{.spec.host}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can check if Prometheus is receiving information: Status → TSDB Status and we will see this table:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/prometheus-status.png" alt="TSDB Status"></span></p>
</div>
<div class="paragraph">
<p>Additionally you can check if all is fine executing the following query:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/prometheus-kafka-brokers.png" alt="Kafka_brokers Query"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_grafana"><a class="anchor" href="#_deploy_grafana"></a>Deploy Grafana</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point, we are able to retrieve and store metric data but we haven&#8217;t a straightforward way to visualize the information or even some way to alert if something goes wrong. Grafana is an excellent tool for these task, widely used and easy to use.</p>
</div>
<div class="paragraph">
<p>Prometheus datasource configuration is allowed by Grafana, even it has a native descriptor for this purpose:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: integreatly.org/v1alpha1
kind: GrafanaDataSource
metadata:
  name: prometheus
spec:
  name: prometheus
  datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus-operated:9090
      isDefault: true
      version: 1
      editable: true
      jsonData:
        tlsSkipVerify: true
        timeInterval: "5s"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also a Grafana instance is necessary, check it out the following descriptor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: integreatly.org/v1alpha1
kind: Grafana
metadata:
  name: grafana
spec:
  ingress:
    enabled: True
  config:
    log:
      mode: "console"
      level: "warn"
    security:
      admin_user: "admin"
      admin_password: "admin1234"
    auth:
      disable_login_form: False
      disable_signout_menu: True
    auth.basic:
      enabled: True
    auth.anonymous:
      enabled: False
  dashboardLabelSelector:
    - matchExpressions:
        - {key: app, operator: In, values: [grafana]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you checked the manifest, then apply them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc apply -n $OCP_NS -f components/monitoring/grafana/grafana-datasource.yaml
oc apply -n $OCP_NS -f components/monitoring/grafana/grafana.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Right now, Grafana has been deployed correctly, however we need to create some dashboards in order to show the information extracted from Prometheus in a useful way. So we are going to configure these dashboard apply the following descriptors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc apply -n $OCP_NS -f components/monitoring/grafana/dashboard</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you need the Grafana URL exposed by route, so execute the following command to get it and then paste in your browser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">oc get route grafana-route -o template --template='{{"https://"}}{{.spec.host}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you access into Grafana a login page show up, the credentials to access are defined in the grafana descriptor that we checked it out previously.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The password for the user admin is admin1234, however we encourage to review the Grafana instance descriptor.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally we can access to the differents dashboards availables (which we are created before):</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/grafana-dashboards.png" alt="Available Grafana Dashboards"></span></p>
</div>
<div class="paragraph">
<p>For instance, go to kafka dashboard:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/grafana-kafka.png" alt="Grafana Kafka Dashboard"></span></p>
</div>
<div class="paragraph">
<p>In this way you can review the information easely even you can create some alert if you need or you can create as much dashboard as you need following the same way that we shows in this laboratory.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="06-data.html" class="query-params-link">6. Data streaming</a></span>
  <span class="next"><a href="08-security.html" class="query-params-link">8. Security</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
