<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Data streaming :: Workshop AMQ Streams</title>
    <link rel="canonical" href="https://github.com/dbgjerez/workshop-amq-streams/workshop-amq-streams/06-data.html">
    <link rel="prev" href="05-user.html">
    <link rel="next" href="07-monitoring.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://github.com/dbgjerez/workshop-amq-streams">Workshop AMQ Streams</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-amq-streams" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">AMQ Streams</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-introduction.html">1. Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-introduction.html#architecture">Architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-operator.html">2. Operator</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-operator.html#installation">Installation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-cluster.html">3. Kafka Cluster</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-topic.html">4. Kafka Topic</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-user.html">5. Kafka User</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-data.html">6. Data streaming</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#producersandconsumers">Producers and consumers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#simple">Simple data</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#sendsimpledata">Send plain text</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#receivesimpledata">Receive plain text</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#json">JSON</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#sendjson">Send JSON</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#receivejson">Receive JSON</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#avro">Avro scheme</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-monitoring.html">7. Monitoring</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-security.html">8. Security</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">AMQ Streams</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">AMQ Streams</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">AMQ Streams</a></li>
    <li><a href="06-data.html">6. Data streaming</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/dbgjerez/workshop-amq-streams/edit/master/doc-gh-pages/documentation/modules/ROOT/pages/06-data.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Data streaming</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>We talked about Kafka topic concept in a previous session. Now it&#8217;s time to send and receive data from a topic.</p>
</div>
<div class="paragraph">
<p>We must understand the consumer, producer and consumer groups to discuss the streaming data concept.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="producersandconsumers"><a class="anchor" href="#producersandconsumers"></a>Producers and consumers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following image shows a topic structure:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/topic-structure.png" alt="Topic structure">
</div>
</div>
<div class="paragraph">
<p>A <strong>producer</strong> is an application that sends data to a topic. If a topic has more than one <strong>partition</strong>, Kafka balances it along the partitions. Also, each partition is replicated along the Kafka brokers depending on the replica factor number, although our application always writes the data in the leader partition.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/topic-producer.png" alt="Topic producer">
</div>
</div>
<div class="paragraph">
<p>The <strong>consumer</strong> is the application that receives the data from a topic partition. More than one application forms a <strong>consumer group</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/topic-consumer-group.png" alt="Topic consumer group">
</div>
</div>
<div class="paragraph">
<p>A consumer group works as a unique functional unit, so the <strong>offset</strong> is unique for each.</p>
</div>
<div class="paragraph">
<p>The <strong>offset</strong> is a point of the latest element consumed by a consumer group. One advantage of using Kafka is that if you modify the offset, the data can be reprocessed.</p>
</div>
<div class="paragraph">
<p>These concepts are essential to have an optimized Kafka architecture. If we think of an optimal architecture, the ideal scenario would be to have the same number of partitions in a topic as applications in each consumer group.</p>
</div>
<div class="paragraph">
<p>If we have more applications than partitions, some applications will do nothing. Oppositely, if we have more partitions than applications, the process won&#8217;t be parallelized.</p>
</div>
<div class="paragraph">
<p>The following image shows two optimized consumer groups with different offsets.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/topic-two-consumer-group.png" alt="Topic two consumer groups">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="simple"><a class="anchor" href="#simple"></a>Simple data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once, we&#8217;ve yet learned about Kafka concepts, it&#8217;s time to play with it.</p>
</div>
<div class="paragraph">
<p>We can work with many data types in Kafka, in this example, we&#8217;re going to show the simplest way to work with simple text data.</p>
</div>
<div class="paragraph">
<p>To do it, we need an application. We can use a lot of languages and frameworks, in this case, we&#8217;re going to use Quarkus and Java 17.</p>
</div>
<div class="paragraph">
<p>Also, we&#8217;ll deploy a topic and users.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The fastest way to deploy this demo section is using ArgoCD, all the information can be found here: <a href="https://github.com/dbgjerez/workshop-amq-streams/tree/master/argocd">https://github.com/dbgjerez/workshop-amq-streams/tree/master/argocd</a>.
</td>
</tr>
</table>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>As an important point, this is not mandatory, but by using it, you&#8217;ll can see something similar to:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/data/demo-data-simple-apps.png" alt="ArgoCD">
</div>
</div>
<div class="sect2">
<h3 id="sendsimpledata"><a class="anchor" href="#sendsimpledata"></a>Send plain text</h3>
<div class="paragraph">
<p>Kafka works with serialized data, in this first lab we are going to send information as a string. This is the easiest way to send information, but also it is usually an ineffective way to work, as we often work with structured data.</p>
</div>
<div class="paragraph">
<p>What do we need to send information to a topic?</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Kafka cluster:</strong> Cluster where create the topic and send the data.</p>
</li>
<li>
<p><strong>Application:</strong> Kafka provides a lot of libraries to work in the most popular programming languages, in this case we&#8217;ve used Java 17 with Quarkus.</p>
</li>
<li>
<p><strong>Topic:</strong> we&#8217;ll create a topic to send the information.</p>
</li>
<li>
<p><strong>Kafka user: </strong> user with enough roles to write in the specific topic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Kafka Cluster</div>
<p>For this example, we&#8217;ll create a simple cluster with internal and TLS security communication:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: data-simple-cluster
spec:
  entityOperator:
    topicOperator: {}
    userOperator: {}
  kafka:
    version: 3.3.1
    config:
      offsets.topic.replication.factor: 1
      transaction.state.log.replication.factor: 1
      transaction.state.log.min.isr: 1
      default.replication.factor: 1
      min.insync.replicas: 1
      inter.broker.protocol.version: "3.3"
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls
    authorization:
      type: simple
    replicas: 1
    storage:
      type: ephemeral
  zookeeper:
    replicas: 1
    storage:
      type: ephemeral</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we can use ArgoCD or apply it directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f content/data/simple/cluster-data-simple.yaml -n demo-data-simple</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we can see the pods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get po -n demo-data-simple
NAME                                                   READY   STATUS    RESTARTS   AGE
data-simple-cluster-entity-operator-6ddbc94d65-bb6vm   3/3     Running   0          96m
data-simple-cluster-kafka-0                            1/1     Running   0          97m
data-simple-cluster-zookeeper-0                        1/1     Running   0          97m</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can wait for the Kafka cluster to stay ready:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get kafka
NAME                  DESIRED KAFKA REPLICAS   DESIRED ZK REPLICAS   READY   WARNINGS
data-simple-cluster   1                        1                     True    True</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Topic</div>
<p>It&#8217;s very important to create a topic with the correct configuration. In this case, we are only going to see how to send data to it, so we only need one partition without a replica.</p>
</div>
<div class="paragraph">
<p>The definition is here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: books
  labels:
    strimzi.io/cluster: data-simple-cluster
spec:
  config:
    # 60m * 60s * 1000ms = 1h
    retention.ms: 3600000
    # 1gb
    segment.bytes: 1073741824
  partitions: 1
  replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we&#8217;ve applied the Kafka cluster definition, we can similarly create the topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f content/data/simple/topic-data-simple.yaml -n demo-data-simple</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can wait for the ready status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get kafkatopic books
NAME    CLUSTER               PARTITIONS   REPLICATION FACTOR   READY
books   data-simple-cluster   1            1                    True</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">User</div>
<p>The next important step is to create the user who the application is going to use. This user needs enough roles to write in the previous topic.</p>
</div>
<div class="paragraph">
<p>This is the corresponding definition, also we can see more about roles and acls in the security section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: kafka-producer-{{ .Values.user.name }}
  labels:
    strimzi.io/cluster: {{ .Values.cluster.name }}
spec:
  authentication:
    type: tls
  authorization:
    type: simple
    acls:
      - resource:
          type: topic
          name: {{ .Values.topic.name }}
          patternType: literal
        operations:
          - Write
        host: "*"</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;ve used Helm to deploy the applications, so you can see some variable placeholders which are overrides in deploy time by ArgoCD.
</td>
</tr>
</table>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The user will be created at the same time that the application is in the following step.</p>
</div>
<div class="paragraph">
<div class="title">Application</div>
<p>Quarkus facilities the way to develop a native application container. The application that sends the data to Kafka is: <a href="https://github.com/dbgjerez/quarkus-kafka/tree/main/simple-kafka-producer" class="bare">https://github.com/dbgjerez/quarkus-kafka/tree/main/simple-kafka-producer</a></p>
</div>
<div class="paragraph">
<p>At this point, we must create some pieces: the deployment, service and user.</p>
</div>
<div class="paragraph">
<p>I usually use ArgoCD and Helm to the facility for this step. If you can&#8217;t use it, you can render the Helm chart with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm template -f demo.values.yaml -n demo-data-simple data/simple/producer | oc apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s essential to understand the security, if we inspect the deployment file, we can see references to the secrets which contain the Kafka cluster certificates.</p>
</div>
<div class="paragraph">
<p>The following picture shows all the objects created by the Helm chart:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/data/data-simple-consumer.png" alt="Simple producer"></span></p>
</div>
<div class="paragraph">
<p>If we consult the application logs in debug mode, we can see how the application is sending messages to the topic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">2023-03-29 08:15:27,789 DEBUG [io.sma.rea.mes.kafka] (executor-thread-0) SRMSG18209: Sending message org.eclipse.microprofile.reactive.messaging.Message$$Lambda$5e1799c60041209b57937765b33186671a72f6f8@252653dc to Kafka topic 'books'
2023-03-29 08:15:27,791 DEBUG [io.sma.rea.mes.kafka] (kafka-producer-network-thread | kafka-producer-books-new) SRMSG18211: Message org.eclipse.microprofile.reactive.messaging.Message$$Lambda$5e1799c60041209b57937765b33186671a72f6f8@252653dc sent successfully to Kafka topic-partition 'books-0', with offset 4697</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following step is to consume the messages.</p>
</div>
</div>
<div class="sect2">
<h3 id="receivesimpledata"><a class="anchor" href="#receivesimpledata"></a>Receive plain text</h3>
<div class="paragraph">
<p>This step is very similar to the previous one, as the cluster and topic have been deployed yet, we will just deploy the application consumer and a user.</p>
</div>
<div class="paragraph">
<p>This application is a listener over a topic. The idea is to read the data that the previous application is sending to the topic.</p>
</div>
<div class="paragraph">
<div class="title">User</div>
<p>This user needs enough roles to read the topic and roles to use the Consumer Group.</p>
</div>
<div class="paragraph">
<p>This is the corresponding definition, also we can see more about roles and acls in the security section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: kafka-consumer-{{ .Values.user.name }}
  labels:
    strimzi.io/cluster: {{ .Values.cluster.name }}
spec:
  authentication:
    type: tls
  authorization:
    type: simple
    acls:
      - resource:
          name: cg-simple-kafka-consumer
          patternType: literal
          type: group
        operations: 
          - Read
        host: "*"
      - resource:
          name: {{ .Values.topic.name }}
          patternType: literal
          type: topic
        operations: 
          - Read
        host: "*"</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;ve used Helm to deploy the applications, so you can see some variable placeholders which are overrides in deploy time by ArgoCD.
</td>
</tr>
</table>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The user will be created at the same time that the application is in the following step.</p>
</div>
<div class="paragraph">
<div class="title">Application</div>
<p>The application that we&#8217;re going to use, has been programmed using Quarkus too. In summary, the process is very similar to what we&#8217;ve used in the producer application.</p>
</div>
<div class="paragraph">
<p>I usually use ArgoCD and Helm to the facility for this step. If you can&#8217;t use it, you can render the Helm chart with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm template -f demo.values.yaml -n demo-data-simple data/simple/consumer | oc apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you use ArgoCD, you can see easily the objects created by the chart:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/data/data-simple-consumer.png" alt="Simple consumer"></span></p>
</div>
<div class="paragraph">
<p>If we consult the application logs in info mode, we can see how the application is consuming the messages that the producer is sending.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">2023-03-29 06:58:02,300 INFO  [io.dbo.ser.BookConsumer] (vert.x-eventloop-thread-0) Book[ title: The Lord of the Rings, Pages: 47 ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we can play with the partitions to show how the consumer group actuates over the topic.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="json"><a class="anchor" href="#json"></a>JSON data</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sendjson"><a class="anchor" href="#sendjson"></a>Send JSON</h3>

</div>
<div class="sect2">
<h3 id="receivejson"><a class="anchor" href="#receivejson"></a>Receive JSON</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="avro"><a class="anchor" href="#avro"></a>Avro schemes</h2>
<div class="sectionbody">

</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="05-user.html" class="query-params-link">5. Kafka User</a></span>
  <span class="next"><a href="07-monitoring.html" class="query-params-link">7. Monitoring</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
