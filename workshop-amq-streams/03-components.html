<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Components :: Workshop Service Mesh</title>
    <link rel="canonical" href="https://github.com/dbgjerez/workshop-amq-streams/workshop-amq-streams/03-components.html">
    <link rel="prev" href="02-operator.html">
    <link rel="next" href="04-data.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://github.com/dbgjerez/workshop-amq-streams">Workshop Service Mesh</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="workshop-amq-streams" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">AMQ Streams</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-introduction.html">1. Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-introduction.html#architecture">Architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-operator.html">2. Operator</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-operator.html#installation">Installation</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-components.html">3. Kafka components</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cluster">Deploy a Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#topic">Deploy a Topic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#user">Deploy a User</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-data.html">4. Data</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-data.html#simple">Simple data</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-data.html#sendsimpledata">Send plain text</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-data.html#receivesimpledata">Receive plain text</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-data.html#json">JSON</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-data.html#sendjson">Send JSON</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-data.html#receivejson">Receive JSON</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-data.html#avro">Avro scheme</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-monitoring.html">5. Monitoring</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-security.html">6. Security</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">AMQ Streams</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">AMQ Streams</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">AMQ Streams</a></li>
    <li><a href="03-components.html">3. Kafka components</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/dbgjerez/workshop-amq-streams/edit/master/doc-gh-pages/documentation/modules/ROOT/pages/03-components.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Components</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><img src="_images/kafka-components.png" alt="Kafka components"></span></p>
</div>
<div class="paragraph">
<p>The main components in a Kafka architecture:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Broker:</strong> node that orchestrates the storage and passing of messages.</p>
</li>
<li>
<p><strong>Kafka Cluster:</strong> group of broker instances.</p>
</li>
<li>
<p><strong>ZooKeeper:</strong> core dependency for Kafka that provides a cluster coordination service, storing and tracking the status of brokers and consumers. It&#8217;s also used for controller elections.</p>
</li>
<li>
<p><strong>Kafka Connect:</strong> integration toolkit for streaming data between Kafka brokers and other systems. Kafka Connect provides a framework to integrate Kafka with an external data source such as a database. A connector is a plugin composed by:</p>
<div class="ulist">
<ul>
<li>
<p>Source to extract the data from a source.</p>
</li>
<li>
<p>Sink to store the data into a Kafka topic.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Kafka MirrorMaker:</strong> replicates data between two Kafka clusters, within or across data centers.</p>
</li>
<li>
<p><strong>Kafka Exporter:</strong> extracts data for analysis.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cluster"><a class="anchor" href="#cluster"></a>Kafka Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab, we&#8217;ll create our first AMQ Streams cluster.</p>
</div>
<div class="paragraph">
<p>Prerequisites:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AMQ Streams operator installed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Goals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand what is a Kafka Cluster</p>
</li>
<li>
<p>Be able to manage a cluster</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If we would like to install a Kafka cluster without a Strimzi operator, we must install and configure each component of the architecture.</p>
</div>
<div class="paragraph">
<p>Thanks to the operator, the installation is easy, we only have to understand how to configure it.</p>
</div>
<div class="paragraph">
<p>The descriptor used to deploy a Kafka cluster is <strong>Kafka</strong> and we can see an example here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: kafka-cluster-demo
spec:
  entityOperator:
    topicOperator: {}
    userOperator: {}
  kafka:
    version: 3.3.1
    config:
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      default.replication.factor: 3
      min.insync.replicas: 2
      inter.broker.protocol.version: '3.3'
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
      - name: tls
        port: 9093
        type: internal
        tls: true
    replicas: 3
    storage:
      type: ephemeral
  zookeeper:
    replicas: 3
    storage:
      type: ephemeral</code></pre>
</div>
</div>
<div class="paragraph">
<p>The most important parts to understand now:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>listeners:</strong> connection endpoints that can be used by the applications</p>
</li>
<li>
<p><strong>replicas:</strong> the number of replications for kafka brokers or ZooKeeper instances.</p>
</li>
<li>
<p><strong>storage:</strong> in this case is ephemeral, but it can be a persistent-claim</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this laboratory, we&#8217;ll use a namespaced called "kafka-components", so to facilitate the operation, we can create the project and assign the value to a variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">OCP_NS=kafka-components
oc create namespace $OCP_NS</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we can use the new project as default project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project $OCP_NS</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we&#8217;ll start up a cluster. To do it, we apply the previous Kafka definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f content/components/kafka-cluster/kafka-cluster-demo.yaml -n $OCP_NS</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cluster provisioning may take some minutes as some pieces have to be configured.</p>
</div>
<div class="paragraph">
<p>After some minutes, the cluster is ready to be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get po -n $OCP_NS
NAME                                                 READY   STATUS    RESTARTS   AGE
kafka-cluster-demo-entity-operator-c9ccdddb7-7bmpr   3/3     Running   0          46s
kafka-cluster-demo-kafka-0                           1/1     Running   0          70s
kafka-cluster-demo-kafka-1                           1/1     Running   0          70s
kafka-cluster-demo-kafka-2                           1/1     Running   0          70s
kafka-cluster-demo-zookeeper-0                       1/1     Running   0          103s
kafka-cluster-demo-zookeeper-1                       1/1     Running   0          103s
kafka-cluster-demo-zookeeper-2                       1/1     Running   0          103s</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s very important to understand why is running some pods. There are 6 because we had indicated the replica of Zookeeper and Kafka to value 3.</p>
</div>
<div class="paragraph">
<p>In addition, we can consult our running clusters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get kafka
NAME                 DESIRED KAFKA REPLICAS   DESIRED ZK REPLICAS   READY   WARNINGS
kafka-cluster-demo   3                        3                     True</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the cluster is up and running, we will delete it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete kafka kafka-cluster-demo -n $OCP_NS
kafka.kafka.strimzi.io "kafka-cluster-demo" deleted</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="topic"><a class="anchor" href="#topic"></a>Kafka Topic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These labs pretend to introduce about the topic concept in Kafka.</p>
</div>
<div class="paragraph">
<p>Prerequisites:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AMQ Streams operator installed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Goals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka topic concepts</p>
</li>
<li>
<p>How to create a topic</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Kafka cluster</strong> works as a group of <strong>brokers</strong>.</p>
</div>
<div class="paragraph">
<p>The data is stored in <strong>Topics</strong>. Each topic has one or many partitions where the data is distributed.</p>
</div>
<div class="paragraph">
<p>A <strong>partition</strong> has a data subset of the topic. Thanks to this, the data processing can be parallelized.</p>
</div>
<div class="paragraph">
<p>Another important point is the <strong>replication factor</strong>. When a topic is divided in partitions, we earn the ability of parallelization, but we need high availability in most cases. With the replication factor, we indicate to Kafka how many times this partition should be replicated along the brokers. These replications are not productive, they are followers of the main that only work in case of fail in the partition leader.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/kafka-concepts-key-concepts.png" alt="How to Kafka operate">
</div>
</div>
<div class="paragraph">
<p>To deploy a topic we have to apply a <strong>KafkaTopic</strong> descriptor. The descriptor shows like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">404: Not Found</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see a lot of important configuration points:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>config.retention.ms:</strong> represents the time before the data is deleted</p>
</li>
<li>
<p><strong>config.segment.bytes:</strong> controls the segment file size for the log</p>
</li>
<li>
<p><strong>partitions:</strong> number of partitions of the topic</p>
</li>
<li>
<p><strong>replicas:</strong> number of replicas in each partition</p>
</li>
<li>
<p><strong>topicName:</strong> name of the topic when the client connects inside the cluster</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To deploy the topic is needed a cluster. We&#8217;re going to reuse the cluster used to explain the Kafka clusters.</p>
</div>
<div class="paragraph">
<p>We recreate it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f content/components/kafka-cluster/kafka-cluster-demo.yaml -n $OCP_NS</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can wait while the operator is starting up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get kafka -w
NAME                 DESIRED KAFKA REPLICAS   DESIRED ZK REPLICAS   READY   WARNINGS
kafka-cluster-demo   3                        3
kafka-cluster-demo   3                        3                     True</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, once the cluster is up, we can deploy the topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f content/components/kafka-topic/kafka-simple-topic.yaml -n $OCP_NS</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can ask for it with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get kafkatopic -n $OCP_NS simple-topic-demo
NAME                CLUSTER              PARTITIONS   REPLICATION FACTOR   READY
simple-topic-demo   kafka-cluster-demo   1            2                    True</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, the topic is ready to receive and send the data.</p>
</div>
<div class="paragraph">
<p>If we enter inside a Kafka broker container, we can navigate to the filesystem when the topic is created and his data is stored.</p>
</div>
<div class="paragraph">
<p>To list the brokers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get po -n $OCP_NS | grep demo-kafka | awk '{print $1}'
kafka-cluster-demo-kafka-0
kafka-cluster-demo-kafka-1
kafka-cluster-demo-kafka-2</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enter inside and list the filesystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc exec -it -n $OCP_NS kafka-cluster-demo-kafka-0 ls /var/lib/kafka/data/kafka-log0/</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we indicated the replica value=2 and the partition=1, we can see the topic only in 2 brokers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user"><a class="anchor" href="#user"></a>Kafka User</h2>
<div class="sectionbody">

</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-operator.html" class="query-params-link">2. Operator</a></span>
  <span class="next"><a href="04-data.html" class="query-params-link">4. Data</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
